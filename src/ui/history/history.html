<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review History - GitHub PR Review Extractor</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #24292f;
      background: #f6f8fa;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #24292f;
    }

    .subtitle {
      color: #57606a;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .controls input, .controls select {
      padding: 8px 12px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      font-size: 14px;
    }

    .controls input[type="search"] {
      flex: 1;
      min-width: 200px;
    }

    button {
      padding: 8px 16px;
      background: #2da44e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    button:hover {
      background: #2c974b;
    }

    button.secondary {
      background: #f6f8fa;
      color: #24292f;
      border: 1px solid #d0d7de;
    }

    button.secondary:hover {
      background: #f3f4f6;
    }

    button.danger {
      background: #da3633;
      color: white;
    }

    button.danger:hover {
      background: #b62324;
    }

    .history-list {
      display: grid;
      gap: 16px;
    }

    .history-item {
      padding: 16px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background: #f6f8fa;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .history-item-title {
      font-size: 16px;
      font-weight: 600;
      color: #0969da;
      text-decoration: none;
      margin-bottom: 4px;
      display: block;
    }

    .history-item-title:hover {
      text-decoration: underline;
    }

    .history-item-meta {
      font-size: 12px;
      color: #57606a;
      margin-bottom: 8px;
    }

    .history-item-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #57606a;
      margin-bottom: 12px;
    }

    .history-item-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .history-item-actions button {
      padding: 4px 12px;
      font-size: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #57606a;
    }

    .empty-state h2 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #24292f;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #57606a;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“š Review History</h1>
    <p class="subtitle">View and manage your previous code review extractions</p>

    <div class="controls">
      <input type="search" id="searchInput" placeholder="Search by PR URL or title...">
      <select id="sortSelect">
        <option value="timestamp-desc">Newest first</option>
        <option value="timestamp-asc">Oldest first</option>
        <option value="totalIssues-desc">Most issues first</option>
        <option value="totalIssues-asc">Fewest issues first</option>
        <option value="prTitle-asc">Title A-Z</option>
        <option value="prTitle-desc">Title Z-A</option>
      </select>
      <button id="exportBtn" class="secondary">Export JSON</button>
      <button id="clearBtn" class="danger">Clear All</button>
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>

    <div id="historyList" class="history-list">
      <div class="loading">Loading history...</div>
    </div>
  </div>

  <script src="review-history.js"></script>
  <script>
    let allHistory = [];
    let filteredHistory = [];

    // Load and display history
    async function loadHistory() {
      const listContainer = document.getElementById('historyList');
      listContainer.innerHTML = '<div class="loading">Loading history...</div>';

      try {
        allHistory = await getReviewHistory();
        filteredHistory = [...allHistory];
        renderHistory();
      } catch (error) {
        console.error('Failed to load history:', error);
        listContainer.innerHTML = '<div class="empty-state"><h2>Error</h2><p>Failed to load history. Please try again.</p></div>';
      }
    }

    // Render history list
    function renderHistory() {
      const listContainer = document.getElementById('historyList');

      if (filteredHistory.length === 0) {
        listContainer.innerHTML = '<div class="empty-state"><h2>No reviews yet</h2><p>Your extracted reviews will appear here.</p></div>';
        return;
      }

      listContainer.innerHTML = filteredHistory.map(entry => {
        const date = new Date(entry.timestamp);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

        return `
          <div class="history-item">
            <div class="history-item-header">
              <div style="flex: 1;">
                <a href="${entry.prUrl}" target="_blank" class="history-item-title">${escapeHtml(entry.prTitle)}</a>
                <div class="history-item-meta">${dateStr}</div>
              </div>
              <button class="danger" onclick="deleteReview('${entry.id}')" style="font-size: 11px; padding: 4px 8px;">Delete</button>
            </div>
            <div class="history-item-stats">
              <span><strong>${entry.totalIssues}</strong> total issues</span>
              <span><strong>${entry.extractedIssues?.length || 0}</strong> extracted</span>
              <span><strong>${entry.aiGeneratedIssues?.length || 0}</strong> AI generated</span>
            </div>
            <div class="history-item-actions">
              <button class="secondary" onclick="viewReview('${entry.id}')">View Details</button>
              <button class="secondary" onclick="copyIssues('${entry.id}', 'grouped')">Copy Grouped</button>
              <button class="secondary" onclick="copyIssues('${entry.id}', 'json')">Copy JSON</button>
              <button class="secondary" onclick="exportReview('${entry.id}')">Export</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Search/filter history
    function filterHistory() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const sortValue = document.getElementById('sortSelect').value;
      const [sortBy, sortOrder] = sortValue.split('-');

      filteredHistory = allHistory.filter(entry => {
        if (!query) return true;
        return entry.prUrl.toLowerCase().includes(query) ||
               entry.prTitle.toLowerCase().includes(query);
      });

      // Sort
      filteredHistory.sort((a, b) => {
        let comparison = 0;
        if (sortBy === 'timestamp') {
          comparison = new Date(a.timestamp) - new Date(b.timestamp);
        } else if (sortBy === 'totalIssues') {
          comparison = a.totalIssues - b.totalIssues;
        } else if (sortBy === 'prTitle') {
          comparison = a.prTitle.localeCompare(b.prTitle);
        }
        return sortOrder === 'desc' ? -comparison : comparison;
      });

      renderHistory();
    }

    // Delete a review
    async function deleteReview(id) {
      if (!confirm('Are you sure you want to delete this review from history?')) {
        return;
      }

      const success = await deleteReviewFromHistory(id);
      if (success) {
        await loadHistory();
      } else {
        alert('Failed to delete review');
      }
    }

    // View review details
    function viewReview(id) {
      const entry = allHistory.find(e => e.id === id);
      if (!entry) return;

      const details = {
        PR: entry.prTitle,
        URL: entry.prUrl,
        Date: new Date(entry.timestamp).toLocaleString(),
        'Total Issues': entry.totalIssues,
        'Extracted Issues': entry.extractedIssues?.length || 0,
        'AI Generated Issues': entry.aiGeneratedIssues?.length || 0,
        'Exported Formats': entry.exportedFormats?.join(', ') || 'None'
      };

      alert(Object.entries(details).map(([key, value]) => `${key}: ${value}`).join('\n'));
    }

    // Copy issues in specified format
    async function copyIssues(id, format) {
      const entry = allHistory.find(e => e.id === id);
      if (!entry) return;

      const allIssues = [...(entry.extractedIssues || []), ...(entry.aiGeneratedIssues || [])];

      let text = '';
      if (format === 'json') {
        text = JSON.stringify({
          pr: {
            title: entry.prTitle,
            url: entry.prUrl,
            extractedAt: entry.timestamp
          },
          issues: allIssues
        }, null, 2);
      } else {
        // Grouped format
        text = `# Code Review Comments - ${entry.prTitle}\n\n`;
        text += `**PR:** ${entry.prUrl}\n`;
        text += `**Extracted:** ${new Date(entry.timestamp).toLocaleString()}\n`;
        text += `**Total Issues:** ${allIssues.length}\n\n`;
        text += '---\n\n';

        // Group by file
        const grouped = {};
        allIssues.forEach(issue => {
          if (!grouped[issue.filePath]) {
            grouped[issue.filePath] = [];
          }
          grouped[issue.filePath].push(issue);
        });

        Object.entries(grouped).forEach(([filePath, issues]) => {
          text += `## ðŸ“ \`${filePath}\`\n\n`;
          text += `${issues.length} issue${issues.length !== 1 ? 's' : ''} found\n\n`;

          issues.forEach(issue => {
            const severityEmoji = issue.severity === 'critical' ? 'ðŸ”´' :
                                 issue.severity === 'warning' ? 'ðŸŸ¡' : 'ðŸ”µ';
            text += `### ${severityEmoji} ${issue.title}\n\n`;
            text += `**Author:** ${issue.author || 'Unknown'}\n`;
            text += `**Severity:** ${issue.severity?.toUpperCase() || 'SUGGESTION'}\n\n`;
            if (issue.codeContext) {
              text += `**Code:**\n\`\`\`\n${issue.codeContext}\n\`\`\`\n\n`;
            }
            text += `**ðŸ’¡ Suggestion:**\n${issue.content || issue.suggestion || ''}\n\n---\n\n`;
          });
        });
      }

      try {
        await navigator.clipboard.writeText(text);
        alert('Copied to clipboard!');
      } catch (error) {
        console.error('Failed to copy:', error);
        alert('Failed to copy to clipboard');
      }
    }

    // Export single review
    async function exportReview(id) {
      const entry = allHistory.find(e => e.id === id);
      if (!entry) return;

      const json = JSON.stringify(entry, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `review-${id}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Export all history as JSON
    async function exportAllHistory() {
      try {
        const json = await exportHistoryAsJSON();
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `review-history-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Failed to export history:', error);
        alert('Failed to export history');
      }
    }

    // Clear all history
    async function clearAllHistory() {
      if (!confirm('Are you sure you want to clear all review history? This cannot be undone.')) {
        return;
      }

      try {
        await clearReviewHistory();
        await loadHistory();
        alert('History cleared');
      } catch (error) {
        console.error('Failed to clear history:', error);
        alert('Failed to clear history');
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', filterHistory);
    document.getElementById('sortSelect').addEventListener('change', filterHistory);
    document.getElementById('exportBtn').addEventListener('click', exportAllHistory);
    document.getElementById('clearBtn').addEventListener('click', clearAllHistory);
    document.getElementById('refreshBtn').addEventListener('click', loadHistory);

    // Make functions global for onclick handlers
    window.deleteReview = deleteReview;
    window.viewReview = viewReview;
    window.copyIssues = copyIssues;
    window.exportReview = exportReview;

    // Load history on page load
    loadHistory();
  </script>
</body>
</html>

